{% extends "base.html" %}

{% block title %}Comunicados Oficiales{% endblock %}

{% block content %}
    <!-- Barra de búsqueda para filtrar -->
    <div class="mb-8">
        <input type="text" id="search-input" placeholder="Buscar en todos los comunicados..." 
               class="w-full p-3 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition text-gray-800">
    </div>

    <!-- Contenedor de los mensajes -->
    <div id="messages-container" class="space-y-6">
        {% if error %}
            <div class="card p-6 text-center text-red-500">{{ error }}</div>
        {% elif messages %}
            {% for message in messages %}
            <article class="message-card card p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 message-title">{{ message.titulo }}</h2>
                        <p class="text-sm font-medium text-green-700 mt-1 message-author">por {{ message.autor }}</p>
                    </div>
                    <span class="text-sm text-gray-500 text-right flex-shrink-0 ml-4">{{ message.fecha }}</span>
                </div>
                <div class="prose max-w-none leading-relaxed message-content">
                    {{ message.contenido | safe }}
                </div>
            </article>
            {% endfor %}
        {% else %}
            <div class="card p-6 text-center">
                <h3 class="text-xl font-medium">No hay comunicados que mostrar.</h3>
            </div>
        {% endif %}
    </div>

    <!-- Componente de Paginación -->
    <div id="pagination-container" class="mt-10 flex justify-center items-center space-x-2">
        {% if total_pages > 1 %}
            <!-- Botón Anterior -->
            <!-- CORRECCIÓN: Se añade season=season a los enlaces de paginación -->
            <a href="{{ url_for('comunicados', season=season, page=current_page - 1) }}"
               class="px-4 py-2 border border-gray-300 rounded-md text-gray-600 hover:bg-gray-100 {% if current_page == 1 %}pointer-events-none opacity-50{% endif %}">
                Anterior
            </a>

            <!-- Números de Página -->
            {% for page_num in range(1, total_pages + 1) %}
                <a href="{{ url_for('comunicados', season=season, page=page_num) }}"
                   class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 
                          {% if page_num == current_page %}bg-green-600 text-white border-green-600 hover:bg-green-700{% else %}text-gray-600{% endif %}">
                    {{ page_num }}
                </a>
            {% endfor %}

            <!-- Botón Siguiente -->
            <a href="{{ url_for('comunicados', season=season, page=current_page + 1) }}"
               class="px-4 py-2 border border-gray-300 rounded-md text-gray-600 hover:bg-gray-100 {% if current_page == total_pages %}pointer-events-none opacity-50{% endif %}">
                Siguiente
            </a>
        {% endif %}
    </div>

    <!-- Mensaje para cuando no hay resultados de búsqueda -->
    <div id="no-results" class="hidden card p-6 text-center">
        <h3 class="text-xl font-medium">No se encontraron resultados.</h3>
        <p class="text-gray-500 mt-2">Prueba con otros términos de búsqueda.</p>
    </div>

    <script>
        // Almacenamos todos los comunicados en una variable JS
        const allMessages = {{ all_comunicados | tojson }};
        
        const searchInput = document.getElementById('search-input');
        const messagesContainer = document.getElementById('messages-container');
        const paginationContainer = document.getElementById('pagination-container');
        const noResultsDiv = document.getElementById('no-results');
        
        // Guardamos el contenido original para restaurarlo si se borra la búsqueda
        const originalMessagesHTML = messagesContainer.innerHTML;

        // Función para crear el HTML de una tarjeta de mensaje
        function createMessageCard(message) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = message.contenido;
            const contentText = tempDiv.textContent || tempDiv.innerText || "";

            return {
                html: `
                <article class="message-card card p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow duration-300">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900 message-title">${message.titulo}</h2>
                            <p class="text-sm font-medium text-green-700 mt-1 message-author">por ${message.autor}</p>
                        </div>
                        <span class="text-sm text-gray-500 text-right flex-shrink-0 ml-4">${message.fecha}</span>
                    </div>
                    <div class="prose max-w-none leading-relaxed message-content">
                        ${message.contenido}
                    </div>
                </article>
                `,
                searchableText: (message.titulo + message.autor + contentText).toLowerCase()
            };
        }

        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();

            if (searchTerm) {
                // Si hay búsqueda, ocultamos la paginación
                paginationContainer.style.display = 'none';
                noResultsDiv.classList.add('hidden');

                const filteredMessages = allMessages.filter(msg => {
                    const cardData = createMessageCard(msg);
                    return cardData.searchableText.includes(searchTerm);
                });
                
                messagesContainer.innerHTML = ''; // Limpiamos el contenedor

                if (filteredMessages.length > 0) {
                    filteredMessages.forEach(msg => {
                        messagesContainer.innerHTML += createMessageCard(msg).html;
                    });
                } else {
                    // Mostramos el mensaje de "no hay resultados"
                    noResultsDiv.classList.remove('hidden');
                }

            } else {
                // Si la búsqueda está vacía, restauramos la vista original
                paginationContainer.style.display = 'flex';
                noResultsDiv.classList.add('hidden');
                messagesContainer.innerHTML = originalMessagesHTML;
            }
        });
    </script>
{% endblock %}
